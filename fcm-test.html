<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM í…ŒìŠ¤íŠ¸</title>
    <!-- PWA ê´€ë ¨ ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="/images/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="Smile C ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ FCM í…ŒìŠ¤íŠ¸ ë„êµ¬">
    <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œí† ì½œ í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
        const status = document.createElement('div');
        status.style.padding = '10px';
        status.style.margin = '10px 0';
        status.style.border = '1px solid #f00';
        status.style.borderRadius = '5px';
        status.style.backgroundColor = '#fff3f3';
        status.style.color = '#d32f2f';
        
        if (window.location.protocol === 'file:') {
            status.innerHTML = '<strong>ì¤‘ìš” ì˜¤ë¥˜:</strong> ì„œë¹„ìŠ¤ ì›Œì»¤ì™€ FCMì€ file:// í”„ë¡œí† ì½œì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>' +
                               'ì´ í˜ì´ì§€ëŠ” ë°˜ë“œì‹œ ì›¹ ì„œë²„(http:// ë˜ëŠ” https://)ë¥¼ í†µí•´ ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤.<br>' +
                               'ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”: <code>npx http-server</code> ë˜ëŠ” <code>python -m http.server</code>';
            document.body.prepend(status);
        }
        
        if (!('serviceWorker' in navigator)) {
            status.innerHTML = '<strong>ì˜¤ë¥˜:</strong> ì´ ë¸Œë¼ìš°ì €ëŠ” ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            document.body.prepend(status);
        }
        
        // PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/pwa-sw.js')
                .then(registration => {
                    console.log('PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', registration.scope);
                })
                .catch(error => {
                    console.error('PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', error);
                });
        }
        
        // PWA ì„¤ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ë°©ì§€
            e.preventDefault();
            // ì´ë²¤íŠ¸ ì €ì¥
            deferredPrompt = e;
            // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
            showInstallButton();
        });
        
        // PWA ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showInstallButton() {
            const installCard = document.createElement('div');
            installCard.className = 'card';
            installCard.innerHTML = `
                <h2>ğŸ’¡ ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</h2>
                <p>ë” ë‚˜ì€ ê²½í—˜ì„ ìœ„í•´ ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”!</p>
                <button id="install-app" class="button" style="background-color: #e74c3c;">ì•± ì„¤ì¹˜í•˜ê¸°</button>
            `;
            document.body.insertBefore(installCard, document.body.firstChild);
            
            document.getElementById('install-app').addEventListener('click', async () => {
                if (!deferredPrompt) return;
                // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                deferredPrompt.prompt();
                // ì‚¬ìš©ì ì‘ë‹µ ëŒ€ê¸°
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ì‚¬ìš©ì ì‘ë‹µ: ${outcome}`);
                // í”„ë¡¬í”„íŠ¸ë¥¼ í•œ ë²ˆë§Œ í‘œì‹œí•  ìˆ˜ ìˆìŒ
                deferredPrompt = null;
                // ì„¤ì¹˜ í›„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                if (outcome === 'accepted') {
                    installCard.style.display = 'none';
                }
            });
        }
    });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #3498db;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>FCM í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
    
    <div class="card">
        <h2>1. ì•Œë¦¼ ê¶Œí•œ í™•ì¸</h2>
        <button id="check-permission" class="button">ê¶Œí•œ í™•ì¸</button>
        <div id="permission-status" class="status"></div>
    </div>

    <div class="card">
        <h2>2. ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ í™•ì¸</h2>
        <button id="check-sw" class="button">ì„œë¹„ìŠ¤ ì›Œì»¤ í™•ì¸</button>
        <div id="sw-status" class="status"></div>
    </div>

    <div class="card">
        <h2>3. FCM í† í° í™•ì¸</h2>
        <button id="get-token" class="button">í† í° ê°€ì ¸ì˜¤ê¸°</button>
        <div id="token-status" class="status"></div>
        <textarea id="token-value" rows="3" readonly></textarea>
        <div style="margin-top: 10px;">
            <label for="vapid-key">VAPID í‚¤ í™•ì¸:</label>
            <input type="text" id="vapid-key" style="width: 100%; margin-top: 5px;" 
                   value="BFkVSifXl5Jb7dNqyDA0eKPHFCOSWUzgpzxpcZOqdYKZp0YCma-kNZyr3KDxpJ_vwaNaVnVlcwunUmIkKOiwl-s">
            <button id="check-vapid" class="button" style="margin-top: 5px; background-color: #9b59b6;">VAPID í‚¤ ê²€ì¦</button>
            <div id="vapid-status" class="status"></div>
        </div>
        <button id="register-token" class="button" style="margin-top: 10px; background-color: #27ae60;">Firebaseì— í…ŒìŠ¤íŠ¸ ê¸°ê¸°ë¡œ ë“±ë¡</button>
    </div>

    <div class="card">
        <h2>4. ë¡œì»¬ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h2>
        <input type="text" id="notification-title" placeholder="ì•Œë¦¼ ì œëª©" value="í…ŒìŠ¤íŠ¸ ì•Œë¦¼">
        <textarea id="notification-body" placeholder="ì•Œë¦¼ ë‚´ìš©" rows="2">ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì…ë‹ˆë‹¤.</textarea>
        <button id="send-notification" class="button">ì•Œë¦¼ ë³´ë‚´ê¸°</button>
        <div id="notification-status" class="status"></div>
    </div>
    
    <!-- PWA ì„¤ì¹˜ ì•ˆë‚´ -->
    <div class="card">
        <h2>5. ì˜¤í”„ë¼ì¸ ëª¨ë“œ í…ŒìŠ¤íŠ¸</h2>
        <p>ì´ ì•±ì€ PWA(Progressive Web App)ë¡œ êµ¬í˜„ë˜ì–´ ìˆì–´ ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‘ë™í•©ë‹ˆë‹¤.</p>
        <p>í…ŒìŠ¤íŠ¸ ë°©ë²•:</p>
        <ol>
            <li>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ëŠê³ (ë¹„í–‰ê¸° ëª¨ë“œ ë“±) ì•±ì„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”</li>
            <li>ê¸°ë³¸ ê¸°ëŠ¥ì€ ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‘ë™í•´ì•¼ í•©ë‹ˆë‹¤</li>
            <li>Firebase ê´€ë ¨ ê¸°ëŠ¥ì€ ì˜¤í”„ë¼ì¸ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
        </ol>
        <a href="/offline.html" class="button" style="background-color: #9b59b6; text-decoration: none;">ì˜¤í”„ë¼ì¸ í˜ì´ì§€ í™•ì¸</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyCwx7sfeHtmqxb3D-CkyB4DBtFFEpG0ADw",
            authDomain: "smile-c-b8074.firebaseapp.com",
            projectId: "smile-c-b8074",
            storageBucket: "smile-c-b8074.firebasestorage.app",
            messagingSenderId: "747999033560",
            appId: "1:747999033560:web:53d62a80b2086bc3f1ffad",
            measurementId: "G-TK56LG30CK"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        const db = getFirestore(app);
        
        let currentFcmToken = '';

        // ì•Œë¦¼ ê¶Œí•œ í™•ì¸
        document.getElementById('check-permission').addEventListener('click', async () => {
            const permissionStatus = document.getElementById('permission-status');
            try {
                const permission = await Notification.requestPermission();
                permissionStatus.textContent = `í˜„ì¬ ê¶Œí•œ ìƒíƒœ: ${permission}`;
                permissionStatus.className = permission === 'granted' ? 
                    'status success' : 'status error';
            } catch (error) {
                permissionStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                permissionStatus.className = 'status error';
            }
        });

        // ì„œë¹„ìŠ¤ ì›Œì»¤ í™•ì¸
        document.getElementById('check-sw').addEventListener('click', async () => {
            const swStatus = document.getElementById('sw-status');
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length === 0) {
                        swStatus.textContent = 'ë“±ë¡ëœ ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        swStatus.className = 'status error';
                    } else {
                        let swInfo = 'ë“±ë¡ëœ ì„œë¹„ìŠ¤ ì›Œì»¤:';
                        registrations.forEach(reg => {
                            swInfo += `\n- ìŠ¤ì½”í”„: ${reg.scope}, ìƒíƒœ: ${reg.active ? 'í™œì„±' : 'ë¹„í™œì„±'}`;
                        });
                        swStatus.textContent = swInfo;
                        swStatus.className = 'status success';
                    }
                } else {
                    swStatus.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    swStatus.className = 'status error';
                }
            } catch (error) {
                swStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                swStatus.className = 'status error';
            }
        });

        // ì´ˆê¸°í™” ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.getElementById('register-token').disabled = true;
        
        // VAPID í‚¤ ê²€ì¦
        document.getElementById('check-vapid').addEventListener('click', () => {
            const vapidKey = document.getElementById('vapid-key').value.trim();
            const vapidStatus = document.getElementById('vapid-status');
            
            // VAPID í‚¤ ê¸°ë³¸ ê²€ì¦
            if (!vapidKey) {
                vapidStatus.textContent = 'VAPID í‚¤ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';
                vapidStatus.className = 'status error';
                return;
            }
            
            // ê¸¸ì´ ê²€ì¦ (ì¼ë°˜ì ì¸ VAPID í‚¤ëŠ” ê¸¸ì´ê°€ ê¸¸ë‹¤)
            if (vapidKey.length < 50) {
                vapidStatus.textContent = 'VAPID í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìœ íš¨í•œ í‚¤ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
                vapidStatus.className = 'status error';
                return;
            }
            
            // Base64 ë¬¸ì ê²€ì¦
            const base64Regex = /^[A-Za-z0-9\-_=]+$/;
            if (!base64Regex.test(vapidKey)) {
                vapidStatus.textContent = 'VAPID í‚¤ì— ìœ íš¨í•˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Base64 ë¬¸ìë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
                vapidStatus.className = 'status error';
                return;
            }
            
            vapidStatus.textContent = 'VAPID í‚¤ í˜•ì‹ì´ ìœ íš¨í•©ë‹ˆë‹¤. Firebase ì›¹ ì•± ì„¤ì •ì—ì„œ ì›¹ í‘¸ì‹œ ì¸ì¦ì„œê°€ ì œëŒ€ë¡œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
            vapidStatus.className = 'status success';
        });
        
        // FCM í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì»¤ìŠ¤í…€ VAPID í‚¤ ì‚¬ìš©)
        async function getFcmToken() {
            const tokenStatus = document.getElementById('token-status');
            const tokenValue = document.getElementById('token-value');
            const vapidKey = document.getElementById('vapid-key').value.trim();
            
            try {
                tokenStatus.textContent = 'ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì¤‘...';
                tokenStatus.className = 'status';
                
                // ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ í™•ì¸
                const existingRegs = await navigator.serviceWorker.getRegistrations();
                if (existingRegs.length > 0) {
                    console.log('ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ ì°¾ìŒ:', existingRegs);
                }
                
                // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
                    scope: './'
                });
                console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤:', registration);
                
                tokenStatus.textContent = 'ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì™„ë£Œ, FCM í† í° ìš”ì²­ ì¤‘...';
                
                // FCM í† í° ê°€ì ¸ì˜¤ê¸°
                try {
                    const currentToken = await getToken(messaging, {
                        vapidKey: vapidKey,
                        serviceWorkerRegistration: registration
                    });

                    if (currentToken) {
                        currentFcmToken = currentToken;
                        tokenStatus.textContent = 'í† í°ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        tokenStatus.className = 'status success';
                        tokenValue.value = currentToken;
                        document.getElementById('register-token').disabled = false;
                    } else {
                        tokenStatus.textContent = 'í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•Œë¦¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.';
                        tokenStatus.className = 'status error';
                        tokenValue.value = '';
                        document.getElementById('register-token').disabled = true;
                    }
                } catch (tokenError) {
                    console.error('FCM í† í° ê°€ì ¸ì˜¤ê¸° ì„¸ë¶€ ì˜¤ë¥˜:', tokenError);
                    tokenStatus.textContent = `FCM í† í° ì˜¤ë¥˜: ${tokenError.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    tokenStatus.className = 'status error';
                    tokenValue.value = `ì˜¤ë¥˜ ìƒì„¸ ì •ë³´: ${JSON.stringify(tokenError)}`;
                }
            } catch (error) {
                console.error('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì˜¤ë¥˜:', error);
                tokenStatus.textContent = `ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì˜¤ë¥˜: ${error.message}`;
                tokenStatus.className = 'status error';
                tokenValue.value = `ì˜¤ë¥˜ ìƒì„¸ ì •ë³´: ${JSON.stringify(error)}`;
                document.getElementById('register-token').disabled = true;
            }
        }
        
        // í† í° ë²„íŠ¼ì— ìƒˆ í•¨ìˆ˜ ì—°ê²°
        document.getElementById('get-token').addEventListener('click', getFcmToken);

        // Firebaseì— í…ŒìŠ¤íŠ¸ í† í° ë“±ë¡
        document.getElementById('register-token').addEventListener('click', async () => {
            const tokenStatus = document.getElementById('token-status');
            
            if (!currentFcmToken) {
                tokenStatus.textContent = 'ë¨¼ì € í† í°ì„ ê°€ì ¸ì™€ì£¼ì„¸ìš”.';
                tokenStatus.className = 'status error';
                return;
            }
            
            try {
                // Firestoreì— í† í° ë“±ë¡
                const deviceId = 'test-device-' + new Date().getTime();
                await setDoc(doc(db, 'fcmTestTokens', deviceId), {
                    token: currentFcmToken,
                    name: 'í…ŒìŠ¤íŠ¸ ê¸°ê¸° - ì›¹',
                    platform: 'web',
                    createdAt: new Date().toISOString()
                });
                
                tokenStatus.textContent = 'í…ŒìŠ¤íŠ¸ ê¸°ê¸°ë¡œ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ Firebase ì½˜ì†”ì—ì„œ ì´ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì—¬ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                tokenStatus.className = 'status success';
                
            } catch (error) {
                tokenStatus.textContent = `í…ŒìŠ¤íŠ¸ ê¸°ê¸° ë“±ë¡ ì˜¤ë¥˜: ${error.message}`;
                tokenStatus.className = 'status error';
                console.error('í…ŒìŠ¤íŠ¸ ê¸°ê¸° ë“±ë¡ ì˜¤ë¥˜:', error);
            }
        });

        // ë¡œì»¬ ì•Œë¦¼ ë³´ë‚´ê¸°
        document.getElementById('send-notification').addEventListener('click', async () => {
            const title = document.getElementById('notification-title').value;
            const body = document.getElementById('notification-body').value;
            const notificationStatus = document.getElementById('notification-status');
            
            try {
                if (Notification.permission !== 'granted') {
                    await Notification.requestPermission();
                }
                
                if (Notification.permission === 'granted') {
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.ready;
                        await registration.showNotification(title, {
                            body: body,
                            icon: './images/notification-icon.png',
                            badge: './images/notification-badge.png'
                        });
                        
                        notificationStatus.textContent = 'ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        notificationStatus.className = 'status success';
                    } else {
                        const notification = new Notification(title, {
                            body: body,
                            icon: './images/notification-icon.png',
                        });
                        
                        notificationStatus.textContent = 'ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤ (ì„œë¹„ìŠ¤ ì›Œì»¤ ì—†ìŒ).';
                        notificationStatus.className = 'status success';
                    }
                } else {
                    notificationStatus.textContent = 'ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    notificationStatus.className = 'status error';
                }
            } catch (error) {
                notificationStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                notificationStatus.className = 'status error';
                console.error('ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜:', error);
            }
        });
    </script>
</body>
</html> 